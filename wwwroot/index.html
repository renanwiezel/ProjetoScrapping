<!doctype html>
<html lang="pt-BR">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>UOL • Live</title>
    <link rel="stylesheet" href="/styles.css" />
    <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'%3E%3Ccircle cx='16' cy='16' r='16' fill='%2323d0b8'/%3E%3C/svg%3E">
</head>
<body>
    <header class="site-header">
        <div class="wrap header-bar">
            <div class="brand">
                <span class="brand-title">UOL • Live </span>
                <span class="brand-pill"><span style="display:inline-block;width:8px;height:8px;border-radius:999px;background:#23d0b8;box-shadow:0 0 10px #23d0b8;"></span> online</span>
                <span class="muted" id="updated">atualizando…</span>
            </div>
            <div>
                <button id="refreshBtn" class="btn" type="button">Atualizar</button>
            </div>
        </div>
    </header>

    <main class="wrap main">
        <!-- container de mensagens -->
        <div id="banner" aria-live="polite"></div>

        <!-- grid de cards -->
        <div id="list" class="grid" aria-live="polite" aria-busy="true"></div>
    </main>

    <footer class="wrap footer">
        <small>Dados públicos via scraping do seu primão</small>
    </footer>

    <script>
        // Endpoint da API – troque pelo seu domínio público quando publicar
        const API = '/api/noticias/json?site=' + encodeURIComponent('https://noticias.uol.com.br');

        const $updated = document.getElementById('updated');
        const $list = document.getElementById('list');
        const $banner = document.getElementById('banner');
        const $btn = document.getElementById('refreshBtn');

        /* ---------- helpers ---------- */
        function relTime(iso) {
            if (!iso) return '—';
            const d = new Date(iso); if (isNaN(d.getTime())) return '—';
            const s = Math.floor((Date.now() - d.getTime()) / 1000);
            if (s < 60) return `${s}s atrás`;
            const m = Math.floor(s / 60);
            if (m < 60) return `${m}min atrás`;
            const h = Math.floor(m / 60);
            return `${h}h atrás`;
        }

        function showSkeleton(n = 9) {
            $list.innerHTML = Array.from({ length: n }).map(() => `<div class="skeleton"></div>`).join('');
            $list.setAttribute('aria-busy', 'true');
        }

        function showError(msg) {
            $banner.innerHTML = `<div class="alert">${msg}</div>`;
        }

        function clearError() {
            $banner.innerHTML = '';
        }

        function render(items) {
            const html = items.slice(0, 24).map(n => `
            <article class="card">
              <a class="card-link" href="${n.url}" target="_blank" rel="noopener">
                <h3 class="card-title">${n.title || '—'}</h3>
                ${n.description ? `<p class="card-desc">${n.description}</p>` : ``}
                <div class="card-meta">
                  <span>${n.publishedAt ? new Date(n.publishedAt).toLocaleString() : ''}</span>
                  <span></span>
                </div>
              </a>
            </article>
          `).join('');
            $list.innerHTML = html || `<div class="muted">Nada por aqui no momento.</div>`;
            $list.setAttribute('aria-busy', 'false');
        }

        /* ---------- data flow ---------- */
        async function load() {
            try {
                clearError();
                $updated.textContent = 'atualizando…';
                showSkeleton();

                const res = await fetch(API, { cache: 'no-store' });

                // Se o cache do servidor ainda estiver "frio"
                if (res.status === 202) {
                    $updated.textContent = 'preparando dados…';
                    // tenta semear (não bloqueia a UI)
                    fetch('/api/noticias/refresh?site=' + encodeURIComponent('https://noticias.uol.com.br')).catch(() => { });
                    setTimeout(load, 1500);
                    return;
                }

                if (!res.ok) {
                    const txt = await res.text();
                    throw new Error(`Erro ${res.status}: ${txt.slice(0, 200)}`);
                }

                const data = await res.json();
                const items = Array.isArray(data) ? data : (data.items || []);
                const when = Array.isArray(data) ? new Date().toISOString() : (data.updatedAt || new Date().toISOString());

                render(items);
                $updated.textContent = 'Atualizado: ' + relTime(when);
            } catch (err) {
                showError('Não foi possível carregar as notícias. ' + (err?.message || err));
                $updated.textContent = 'erro';
                $list.setAttribute('aria-busy', 'false');
            }
        }

        $btn.addEventListener('click', load);
        // primeira carga
        load();
        // auto-refresh
        setInterval(load, 30000);
    </script>
</body>
</html>
